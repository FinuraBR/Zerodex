<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Jogo ao Zerodex</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/jpg" href="imagens/favicon.jpg">
</head>
<body>
    <header>
        <div class="header-container">
            <h1>Adicionar Jogo</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="jogos.html">Meus Jogos</a></li>
                    <li><a href="sobre.html">Sobre</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="add-game-section">
            <h2>Buscar Jogo na Base de Dados</h2>
            
            <div id="search-container">
                <input type="text" id="api-search-bar" placeholder="Digite o nome de um jogo...">
                <button id="api-search-button" class="cta-button">Buscar</button>
            </div>

            <div id="api-results-container">
                <h3>Resultados da Busca</h3>
                <div class="results-grid">
                    <p>Os resultados da busca aparecerão aqui.</p>
                </div>
            </div>

            <div class="manual-entry-link">
                <button id="manual-entry-button" class="secondary-btn" style="display: none;">Não encontrou? Adicione manualmente</button>
            </div>

            <!-- Formulário (começa escondido) -->
            <div id="add-form-container" style="display: none;">
                <form id="game-entry-form">
                    <div class="form-api-data">
                        <img id="form-game-image" src="" alt="Capa do Jogo" width="150">
                        <div>
                            <div class="form-group">
                                <label for="form-game-title-input">Título do Jogo:</label>
                                <input type="text" id="form-game-title-input" required>
                            </div>
                            <p id="form-game-release">Lançamento: </p>
                        </div>
                    </div>
                    <hr>
                    <div class="form-user-data">
                        <!-- ID, Link da Loja e Imagem Manual -->
                        <div class="form-group-inline">
                            <div class="form-group">
                                <label for="game-id">ID do Jogo:</label>
                                <input type="number" id="game-id" required>
                            </div>
                            <div class="form-group">
                                <label for="game-store-url">URL da Loja (opcional):</label>
                                <input type="text" id="game-store-url" placeholder="https://...">
                            </div>
                        </div>
                        <div class="form-group" id="manual-image-group">
                            <label for="game-image-url">URL da Imagem da Capa:</label>
                            <input type="text" id="game-image-url" placeholder="https://...">
                        </div>
                        <!-- Status -->
                        <div class="form-group"><label for="game-status">Status:</label><select id="game-status" required></select></div>
                        <!-- Plataforma -->
                        <div class="form-group"><label for="game-platform">Plataforma em que joguei:</label><select id="game-platform" required></select></div>
                        <!-- Tradução -->
                        <div class="form-group-inline">
                            <div class="form-group"><label for="game-translation">Tradução:</label><select id="game-translation"><option value="Oficial">Oficial</option><option value="Não possui">Não possui</option><option value="fan">Feita por Fã</option></select></div>
                            <div class="form-group" id="fan-translation-link-group" style="display: none;"><label for="fan-translation-link">Link da Tradução:</label><input type="text" id="fan-translation-link" placeholder="https://..."></div>
                        </div>
                        <!-- Guias -->
                        <div class="form-group"><label>Guias (opcional):</label><div id="guides-list"></div><div class="form-group-inline" style="margin-top: 5px;"><input type="text" id="guide-title" placeholder="Nome do Guia (ex: IGN)"><input type="text" id="guide-url" placeholder="URL do Guia"></div><button type="button" id="add-guide-btn" class="secondary-btn">Adicionar Guia</button></div>
                        <!-- Versão -->
                        <div class="form-group"><label for="game-version">Versão (opcional):</label><select id="game-version"><option value="">Padrão</option><option value="Demo">Demo</option><option value="Acesso Antecipado">Acesso Antecipado</option><option value="Beta">Beta</option></select></div>
                        <!-- Comentário -->
                        <div class="form-group"><label for="game-review">Seu Comentário (opcional):</label><textarea id="game-review" rows="3"></textarea></div>
                        <button type="submit" class="cta-button">Salvar no Zerodex</button>
                    </div>
                </form>
            </div>

            <!-- Área de Resultado -->
            <div id="output-container" style="display: none; margin-top: 30px;">
                <h3>Código Gerado para database.js</h3>
                <p>Copie o código abaixo e cole no topo da lista `gamesData`.</p>
                <textarea id="output-code" rows="15" readonly style="width: 100%; white-space: pre;"></textarea>
                <button type="button" id="copy-code-btn" class="cta-button" style="margin-top: 10px;">Copiar Código</button>
            </div>
        </section>
    </main>
    
    <script src="js/id_counter.js"></script>
    <script src="js/database.js"></script>
    <script>
        // --- CÓDIGO JAVASCRIPT FINAL E LIMPO ---
        const apiKey = "e2de3be265864a059427ea9d4cc4b99f"; // Chave da RAWG
        const searchButton = document.getElementById('api-search-button');
        const searchBar = document.getElementById('api-search-bar');
        const resultsContainer = document.getElementById('api-results-container');
        const resultsGrid = document.querySelector('.results-grid');
        const manualEntryButton = document.getElementById('manual-entry-button');
        const formContainer = document.getElementById('add-form-container');
        const gameEntryForm = document.getElementById('game-entry-form');
        const outputContainer = document.getElementById('output-container');
        const outputCode = document.getElementById('output-code');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const translationSelect = document.getElementById('game-translation');
        const fanTranslationGroup = document.getElementById('fan-translation-link-group');
        const addGuideBtn = document.getElementById('add-guide-btn');
        const guidesList = document.getElementById('guides-list');
        const manualImageGroup = document.getElementById('manual-image-group');
        const formGameTitleInput = document.getElementById('form-game-title-input');

        let currentApiResults = [];
        let selectedGameData = null;
        let tempGuides = [];
        let currentNextId;

        document.addEventListener('DOMContentLoaded', () => { initializeId(); });

        function initializeId() {
            const storedId = parseInt(localStorage.getItem('nextGameId'));
            const fileId = window.nextGameId || 1;
            currentNextId = Math.max(storedId || 1, fileId);
            localStorage.setItem('nextGameId', currentNextId);
        }

        async function searchGames(query) {
            if (!query) return;
            resultsGrid.innerHTML = '<p>Buscando...</p>';
            formContainer.style.display = 'none';
            outputContainer.style.display = 'none';
            try {
                const response = await fetch(`https://api.rawg.io/api/games?key=${apiKey}&search=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                const data = await response.json();
                currentApiResults = data.results;
                displayResults(data.results);
            } catch (error) {
                console.error("Falha ao buscar jogos:", error);
                resultsGrid.innerHTML = `<p class="no-results-message">Ocorreu um erro ao buscar.</p>`;
                manualEntryButton.style.display = 'block';
            }
        }

    function displayResults(games) {
    const resultsGrid = document.querySelector('.results-grid'); // Seleciona o novo container
    manualEntryButton.style.display = 'block';

    if (games.length === 0) {
        resultsGrid.innerHTML = '<p class="no-results-message">Nenhum jogo encontrado.</p>';
        return;
    }

    resultsGrid.innerHTML = games.map(game => `
        <div class="api-result-item" data-game-id="${game.id}">
            <img src="${game.background_image || 'https://placehold.co/300x400?text=Capa'}" alt="${game.name}">
            <div>
                <h3>${game.name}</h3>
                <p>Lançamento: ${game.released || 'Não informado'}</p>
            </div>
        </div>
    `).join('');
}

        function populateForm(gameData) {
            selectedGameData = gameData;
            gameEntryForm.reset();
            tempGuides = [];
            updateGuidesList();
            fanTranslationGroup.style.display = 'none';

            document.getElementById('game-id').value = currentNextId;
            formGameTitleInput.value = gameData.name || '';
            document.getElementById('form-game-image').src = gameData.background_image || 'https://placehold.co/300x400?text=Capa';
            manualImageGroup.style.display = 'block';
            document.getElementById('game-image-url').value = gameData.background_image || '';
            document.getElementById('form-game-release').textContent = `Lançamento: ${gameData.released || 'Não informado'}`;
            document.getElementById('game-store-url').value = gameData.isManual ? '' : `https://rawg.io/games/${gameData.slug}`;

            const statusSelect = document.getElementById('game-status');
            statusSelect.innerHTML = `<option value="playing">Jogando</option><option value="completed">Finalizado</option><option value="completed-100">100% Concluído</option><option value="retired">Aposentado</option><option value="archived">Arquivado</option><option value="abandoned">Abandonado</option>`;
            
            const platformSelect = document.getElementById('game-platform');
            platformSelect.innerHTML = gameData.platforms ? gameData.platforms.map(p => `<option value="${p.platform.slug}">${p.platform.name}</option>`).join('') : '<option value="pc">PC</option><option value="switch">Switch</option>';
            
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        gameEntryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            let translationValue = translationSelect.value;
            if (translationValue === 'fan') {
                const link = document.getElementById('fan-translation-link').value;
                translationValue = link ? `Feita por Fã (<a href="${link}" target="_blank">baixar</a>)` : "Feita por Fã";
            }
            const statusMap = { 'playing': { text: 'Jogando', overlay: 'Jogando Atualmente' }, 'completed': { text: 'Finalizado', overlay: 'Finalizado' }, 'completed-100': { text: '100%', overlay: '100% Concluído' }, 'retired': { text: 'Aposentado', overlay: 'Aposentado' }, 'archived': { text: 'Arquivado', overlay: 'Arquivado' }, 'abandoned': { text: 'Abandonado', overlay: 'Abandonado' } };
            const versionValue = document.getElementById('game-version').value;
            const imageUrl = document.getElementById('game-image-url').value;
            const newGame = {
                id: parseInt(document.getElementById('game-id').value),
                title: formGameTitleInput.value,
                image: imageUrl || "imagens/placeholder.jpg",
                platform: document.getElementById('game-platform').value,
                status: document.getElementById('game-status').value,
                statusText: statusMap[document.getElementById('game-status').value].text,
                statusOverlay: statusMap[document.getElementById('game-status').value].overlay,
                translation: translationValue,
                guide: tempGuides,
                review: document.getElementById('game-review').value || null,
                version: versionValue || null,
                storeUrl: document.getElementById('game-store-url').value || null,
            };
            const outputString = JSON.stringify(newGame, null, 4);
            outputCode.value = `${outputString},\n`;
            outputContainer.style.display = 'block';
            outputContainer.scrollIntoView({ behavior: 'smooth' });
            currentNextId = newGame.id + 1;
            localStorage.setItem('nextGameId', currentNextId);
            document.getElementById('game-id').value = currentNextId;
            copyCodeBtn.textContent = 'Copiar Código (Contador Atualizado!)';
        });

        searchButton.addEventListener('click', () => searchGames(searchBar.value));
        searchBar.addEventListener('keyup', (event) => { if (event.key === 'Enter') searchGames(searchBar.value); });
        resultsContainer.addEventListener('click', (event) => {
            const resultItem = event.target.closest('.api-result-item');
            if (!resultItem) return;
            const gameId = parseInt(resultItem.dataset.gameId);
            const selectedGame = currentApiResults.find(game => game.id === gameId);
            if (selectedGame) populateForm({ ...selectedGame, isManual: false });
        });
        manualEntryButton.addEventListener('click', () => {
            resultsContainer.innerHTML = '';
            const manualGameData = { isManual: true, name: '', background_image: '', released: '', platforms: null };
            populateForm(manualGameData);
        });
        translationSelect.addEventListener('change', () => { fanTranslationGroup.style.display = translationSelect.value === 'fan' ? 'flex' : 'none'; });
        addGuideBtn.addEventListener('click', () => {
            const title = document.getElementById('guide-title').value;
            const url = document.getElementById('guide-url').value;
            if (title && url) { tempGuides.push({ title, url }); updateGuidesList(); document.getElementById('guide-title').value = ''; document.getElementById('guide-url').value = ''; }
        });
        function updateGuidesList() { guidesList.innerHTML = tempGuides.map(g => `<div class="guide-item">${g.title} - <a href="${g.url}" target="_blank">Link</a></div>`).join(''); }
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(outputCode.value).then(() => {
                copyCodeBtn.textContent = 'Copiado!';
                setTimeout(() => { copyCodeBtn.textContent = 'Copiar Código'; }, 2000);
            }).catch(err => { console.error('Falha ao copiar: ', err); copyCodeBtn.textContent = 'Erro ao copiar'; });
        });
    </script>
</body>
</html>
